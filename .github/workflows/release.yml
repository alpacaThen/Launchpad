name: Release Build
permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      sign_build:
        description: 'Sign the build with Developer ID'
        required: false
        type: boolean
        default: false

jobs:
  build-unsigned:
    name: Build Unsigned Release
    runs-on: macos-26
    if: ${{ !inputs.sign_build }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Clean SwiftPM metadata
      run: rm -rf LaunchpadPlus.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
      
    - name: Build LaunchpadPlus (Universal Binary)
      run: |
        xcodebuild clean archive \
          -project LaunchpadPlus.xcodeproj \
          -scheme LaunchpadPlus \
          -configuration Release \
          -archivePath ./build/LaunchpadPlus-arm64.xcarchive \
          -destination 'platform=macOS,arch=arm64' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        
        xcodebuild clean archive \
          -project LaunchpadPlus.xcodeproj \
          -scheme LaunchpadPlus \
          -configuration Release \
          -archivePath ./build/LaunchpadPlus-x86_64.xcarchive \
          -destination 'platform=macOS,arch=x86_64' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Create Universal Binary
      run: |
        # Create output directory
        mkdir -p ./build/universal
        
        # Copy arm64 app as base
        cp -R ./build/LaunchpadPlus-arm64.xcarchive/Products/Applications/LaunchpadPlus.app \
          ./build/universal/LaunchpadPlus.app
        
        # Create universal binary by combining architectures
        lipo -create \
          ./build/LaunchpadPlus-arm64.xcarchive/Products/Applications/LaunchpadPlus.app/Contents/MacOS/LaunchpadPlus \
          ./build/LaunchpadPlus-x86_64.xcarchive/Products/Applications/LaunchpadPlus.app/Contents/MacOS/LaunchpadPlus \
          -output ./build/universal/LaunchpadPlus.app/Contents/MacOS/LaunchpadPlus
        
        # Verify universal binary
        lipo -info ./build/universal/LaunchpadPlus.app/Contents/MacOS/LaunchpadPlus
    
    - name: Create ZIP archive
      run: |
        cd ./build/universal
        zip -r ../../LaunchpadPlus.app.zip LaunchpadPlus.app
        cd ../..
    
    - name: Calculate checksums
      run: |
        shasum -a 256 LaunchpadPlus.app.zip > LaunchpadPlus.app.zip.sha256
        cat LaunchpadPlus.app.zip.sha256
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LaunchpadPlus-unsigned
        path: |
          LaunchpadPlus.app.zip
          LaunchpadPlus.app.zip.sha256
        retention-days: 30
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LaunchpadPlus.app.zip
          LaunchpadPlus.app.zip.sha256
        draft: true
        body: |
          ## ⚠️ Security Notice
          
          This release is **not code-signed or notarized** by Apple. You will need to manually allow it to run.
          
          ### Installation Instructions
          
          1. Download `LaunchpadPlus.app.zip`
          2. Unzip the file
          3. Move `LaunchpadPlus.app` to `/Applications`
          4. Open Terminal and run:
             ```bash
             xattr -cr /Applications/LaunchpadPlus.app
             ```
          5. Launch LaunchpadPlus
          
          See our [Troubleshooting Guide](https://github.com/kristof12345/Launchpad/blob/main/TROUBLESHOOTING.md) for more details.
          
          ### Verification
          
          SHA-256 checksum: (see `.sha256` file)
          
          ## What's Changed
          
          <!-- Add release notes here -->

  build-signed:
    name: Build Signed Release
    runs-on: macos-26
    if: ${{ inputs.sign_build }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: Import Code Signing Certificates
      if: ${{ secrets.CERTIFICATES_P12 != '' }}
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
        p12-password: ${{ secrets.CERTIFICATES_PASSWORD }}
    
    - name: Clean SwiftPM metadata
      run: rm -rf LaunchpadPlus.xcodeproj/project.xcworkspace/xcshareddata/swiftpm
    
    - name: Build and Archive (Signed)
      run: |
        xcodebuild archive \
          -project LaunchpadPlus.xcodeproj \
          -scheme LaunchpadPlus \
          -configuration Release \
          -archivePath ./build/LaunchpadPlus.xcarchive \
          -destination 'platform=macOS' \
          CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
          DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM }}"
    
    - name: Export Archive
      run: |
        # Create export options plist
        cat > ./build/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>teamID</key>
            <string>${{ secrets.DEVELOPMENT_TEAM }}</string>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath ./build/LaunchpadPlus.xcarchive \
          -exportPath ./build/export \
          -exportOptionsPlist ./build/ExportOptions.plist
    
    - name: Notarize (if credentials available)
      if: ${{ secrets.APPLE_ID != '' }}
      run: |
        # Create ZIP for notarization
        cd ./build/export
        zip -r ../../LaunchpadPlus-signed.zip LaunchpadPlus.app
        cd ../..
        
        # Submit for notarization
        xcrun notarytool submit LaunchpadPlus-signed.zip \
          --apple-id "${{ secrets.APPLE_ID }}" \
          --team-id "${{ secrets.DEVELOPMENT_TEAM }}" \
          --password "${{ secrets.NOTARIZATION_PASSWORD }}" \
          --wait
        
        # Staple the ticket
        xcrun stapler staple ./build/export/LaunchpadPlus.app
        
        # Re-create ZIP with stapled app
        rm LaunchpadPlus-signed.zip
        cd ./build/export
        zip -r ../../LaunchpadPlus-signed.zip LaunchpadPlus.app
        cd ../..
    
    - name: Create Final ZIP
      if: ${{ secrets.APPLE_ID == '' }}
      run: |
        cd ./build/export
        zip -r ../../LaunchpadPlus-signed.zip LaunchpadPlus.app
        cd ../..
    
    - name: Calculate checksums
      run: |
        shasum -a 256 LaunchpadPlus-signed.zip > LaunchpadPlus-signed.zip.sha256
        cat LaunchpadPlus-signed.zip.sha256
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LaunchpadPlus-signed
        path: |
          LaunchpadPlus-signed.zip
          LaunchpadPlus-signed.zip.sha256
        retention-days: 30
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LaunchpadPlus-signed.zip
          LaunchpadPlus-signed.zip.sha256
        draft: true
        body: |
          ## ✅ Code Signed and Notarized
          
          This release is **code-signed and notarized** by Apple. You can install it normally without security warnings.
          
          ### Installation Instructions
          
          1. Download `LaunchpadPlus-signed.zip`
          2. Unzip the file
          3. Move `LaunchpadPlus.app` to `/Applications`
          4. Launch LaunchpadPlus
          
          ### Verification
          
          SHA-256 checksum: (see `.sha256` file)
          
          To verify the signature:
          ```bash
          codesign -dvv /Applications/LaunchpadPlus.app
          spctl -a -vv /Applications/LaunchpadPlus.app
          ```
          
          ## What's Changed
          
          <!-- Add release notes here -->
